<?xml version="1.0" encoding="UTF-8"?><!-- 
	수정일				수정내용
  ========= 		=================================================
  2025.02.27		DART 정보
-->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="StockDataDAO">

		<select id="selectStocksList"  parameterType="egovframework.stock.data.service.StocksDataVO" resultType="egovMap">
		<![CDATA[
		 SELECT * FROM ( SELECT rownum rn, TB.* FROM (
			SELECT /*selectStockList*/
				 A.STOCKS_CODE
				,A.STOCKS_NAME
				,A.STOCKS_GUBUN
				,(CASE WHEN A.STOCKS_GUBUN = 'KOSDAQ' THEN '코스닥' ELSE '코스피' END) AS STOCKS_GUBUN_NM
				,A.HOMEPAGE
				,A.UPJONG
				,A.MAIN_PRDUCT
				,(SELECT COUNT(1) FROM STOCKS_HIST WHERE STOCKS_CODE = A.STOCKS_CODE) AS HIST_CNT
				,(SELECT TO_CHAR(MAX(UPT_DATE),'YYYY-MM-DD') FROM STOCKS_HIST WHERE STOCKS_CODE = A.STOCKS_CODE) AS HIST_UPT_DATE
				,TO_CHAR(A.UPT_DATE,'YYYY-MM-DD') AS UPT_DATE
                ,TO_CHAR(A.REG_DATE,'YYYY-MM-DD') AS REG_DATE
			FROM STOCKS_LIST A
			WHERE 1=1
			]]>
			<if test="searchKeyword != null and searchKeyword != ''">
				<choose>
					<when test="cl == 'UPJONG'">
						<![CDATA[AND A.UPJONG LIKE '%'||#{searchKeyword}||'%']]>
					</when>
					<when test="cl == 'PRDUCT'">
						<![CDATA[AND A.MAIN_PRDUCT LIKE '%'||#{searchKeyword}||'%']]>
					</when>
					<otherwise>
						<![CDATA[AND A.STOCKS_NAME LIKE '%'||#{searchKeyword}||'%']]>
					</otherwise>
				</choose>
			</if>
			<if test="gubun != null and gubun != ''">
				<![CDATA[AND A.STOCKS_GUBUN = #{gubun}]]>
			</if>
			<![CDATA[
			ORDER BY A.UPT_DATE DESC, A.STOCKS_NAME
			  ) TB )  WHERE rn BETWEEN #{firstIndex} + 1 AND #{firstIndex} + #{recordCountPerPage}
			]]> 
	</select>
	
	<select id="selectStocksListTotCnt" parameterType="egovframework.stock.data.service.StocksDataVO" resultType="int">
		
		SELECT COUNT(A.STOCKS_CODE) AS "totcnt" FROM STOCKS_LIST A
		WHERE 1=1
		<if test="searchKeyword != null and searchKeyword != ''">
			<choose>
					<when test="cl == 'UPJONG'">
						<![CDATA[AND A.UPJONG LIKE '%'||#{searchKeyword}||'%']]>
					</when>
					<when test="cl == 'PRDUCT'">
						<![CDATA[AND A.MAIN_PRDUCT LIKE '%'||#{searchKeyword}||'%']]>
					</when>
					<otherwise>
						<![CDATA[AND A.STOCKS_NAME LIKE '%'||#{searchKeyword}||'%']]>
					</otherwise>
				</choose>
		</if>
		<if test="gubun != null and gubun != ''">
			<![CDATA[AND A.STOCKS_GUBUN = #{gubun}]]>
		</if>
		
	</select>
	
	<!-- 종목 상세 조회 -->
	<select id="selectStocksDetail"  parameterType="egovframework.stock.data.service.StocksDataVO" resultType="egovMap">
		<![CDATA[
			SELECT /*selectStocksDetail*/
				 A.STOCKS_CODE
				,A.STOCKS_NAME
				,A.STOCKS_GUBUN
				,(CASE WHEN A.STOCKS_GUBUN = 'KOSDAQ' THEN '코스닥' ELSE '코스피' END) AS STOCKS_GUBUN_NM
				,A.HOMEPAGE
				,A.UPJONG
				,A.MAIN_PRDUCT
				,A.COUNTRY
				,TO_CHAR(A.UPT_DATE,'YYYY-MM-DD') AS UPT_DATE
                ,TO_CHAR(A.REG_DATE,'YYYY-MM-DD') AS REG_DATE
			FROM STOCKS_LIST A
			WHERE A.STOCKS_CODE = #{stocksCode}
			]]>
	</select>
	
	<insert id="insertStocksInfo" parameterType="java.util.Map">
	<![CDATA[
        MERGE INTO STOCKS_LIST T
        USING DUAL
        ON (
        		T.STOCKS_CODE = #{stocksCode} 
        		)
        WHEN NOT MATCHED THEN
            INSERT (
                STOCKS_CODE,
				STOCKS_NAME,
				STOCKS_GUBUN,
				HOMEPAGE,
				UPJONG,
				MAIN_PRDUCT,
				COUNTRY,
				REG_DATE,
				UPT_DATE
            ) VALUES (
                #{stocksCode},
                #{stocksName},
                #{stocksGubun},
                #{homepage},
                #{upjong},
                #{mainPrduct},
                NVL(#{country},'KOR'),
                SYSDATE,
                SYSDATE
            )
	]]>
    </insert>
    
    <!-- 종목 정보 수정 -->
	<update id="updateStocksInfo" parameterType="java.util.Map">
		<![CDATA[/*updateStocksInfo*/
			UPDATE STOCKS_LIST
			SET 	STOCKS_NAME = NVL(#{stocksName},STOCKS_NAME),
					STOCKS_GUBUN = #{stocksGubun},
					HOMEPAGE = #{homepage},
					UPJONG = #{upjong},
					MAIN_PRDUCT = #{mainPrduct},
					COUNTRY = NVL(#{country},'KOR'),
					UPT_DATE = SYSDATE
			WHERE STOCKS_CODE = #{stocksCode} 
		]]>
	</update>
	
	<!-- 종목 정보 삭제 -->
	<delete id="deleteStocksInfo" parameterType="java.util.Map">
		<![CDATA[/*deleteStocksInfo*/
			DELETE FROM STOCKS_LIST
			WHERE STOCKS_CODE = #{stocksCode} 	
		]]>
	</delete>
	
	<select id="selectStockHistList"  parameterType="java.util.Map" resultType="egovMap">
		<![CDATA[
		 SELECT * FROM ( SELECT rownum rn, TB.* FROM (
			SELECT /*selectStockHistList*/
				A.SEQ
				,A.STOCKS_CODE
				,B.STOCKS_NAME
				,A.COLLECTION_DATE
				,A.TITLE
				,A.ORIGIN
				,A.EVALUATION
				,TO_CHAR(A.UPT_DATE,'YYYY-MM-DD') AS UPT_DATE
                ,TO_CHAR(A.REG_DATE,'YYYY-MM-DD') AS REG_DATE
			FROM STOCKS_HIST A , STOCKS_LIST B
			WHERE A.STOCKS_CODE = B.STOCKS_CODE(+)
			AND A.STOCKS_CODE = #{stocksCode}
			]]>
			<if test="searchKeyword != null and searchKeyword != ''">
				<choose>
					<when test="gubun == 'TITLE'">
						<![CDATA[AND A.TITLE LIKE '%'||#{searchKeyword}||'%']]>
					</when>
					<when test="gubun == 'ORIGIN'">
						<![CDATA[AND A.ORIGIN LIKE '%'||#{searchKeyword}||'%']]>
					</when>
					<otherwise>
						<![CDATA[AND A.TITLE LIKE '%'||#{searchKeyword}||'%']]>
					</otherwise>
				</choose>
			</if>
			<![CDATA[
			ORDER BY A.UPT_DATE DESC, A.REG_DATE DESC
			  ) TB )  WHERE rn BETWEEN #{firstIndex} + 1 AND #{firstIndex} + #{recordCountPerPage}
			]]> 
	</select>
	
	<select id="selectStockHistListTotCnt" parameterType="java.util.Map" resultType="int">
		<![CDATA[
		SELECT 
			COUNT(A.SEQ) AS TOT_CNT 
		FROM STOCKS_HIST A
		WHERE A.STOCKS_CODE = #{stocksCode}
		]]>
		<if test="searchKeyword != null and searchKeyword != ''">
				<choose>
					<when test="gubun == 'TITLE'">
						<![CDATA[AND A.TITLE LIKE '%'||#{searchKeyword}||'%']]>
					</when>
					<when test="gubun == 'ORIGIN'">
						<![CDATA[AND A.ORIGIN LIKE '%'||#{searchKeyword}||'%']]>
					</when>
					<otherwise>
						<![CDATA[AND A.TITLE LIKE '%'||#{searchKeyword}||'%']]>
					</otherwise>
				</choose>
			</if>
	</select>
	
	<!-- 종목 이력 상세 정보 -->
	<select id="selectStockHistDetail"  parameterType="java.util.Map" resultType="egovMap">
		<![CDATA[
			SELECT /*selectStockHistDetail*/
				A.SEQ
				,A.STOCKS_CODE
				,B.STOCKS_NAME
				,A.COLLECTION_DATE
				,A.TITLE
				,A.ORIGIN
				,A.EVALUATION
				,DBMS_LOB.SUBSTR(A.USER_SUMMARY, 1500, 1) AS USER_SUMMARY1
                ,DBMS_LOB.SUBSTR(A.USER_SUMMARY, 1500, 1501) AS USER_SUMMARY2
                ,DBMS_LOB.SUBSTR(A.USER_SUMMARY, 1500, 3001) AS USER_SUMMARY3
                ,DBMS_LOB.SUBSTR(A.USER_SUMMARY, 1500, 4501) AS USER_SUMMARY4
                ,DBMS_LOB.SUBSTR(A.USER_SUMMARY, 1500, 6001) AS USER_SUMMARY5
                ,DBMS_LOB.SUBSTR(A.USER_SUMMARY, 1500, 7501) AS USER_SUMMARY6
                ,DBMS_LOB.SUBSTR(A.USER_SUMMARY, 1500, 9001) AS USER_SUMMARY7
                ,DBMS_LOB.SUBSTR(A.USER_SUMMARY, 1500, 10501) AS USER_SUMMARY8
                ,DBMS_LOB.SUBSTR(A.USER_SUMMARY, 1500, 12001) AS USER_SUMMARY9
				,TO_CHAR(A.UPT_DATE,'YYYY-MM-DD') AS UPT_DATE
                ,TO_CHAR(A.REG_DATE,'YYYY-MM-DD') AS REG_DATE
			FROM STOCKS_HIST A , STOCKS_LIST B
			WHERE A.STOCKS_CODE = B.STOCKS_CODE(+)
			AND A.STOCKS_CODE = #{stocksCode}
			AND A.SEQ = #{seq}
			]]> 
	</select>
	
	<!-- 종목 이력 등록 -->
	<insert id="insertStockHist" parameterType="java.util.Map">
           INSERT INTO STOCKS_HIST (
                SEQ,
				STOCKS_CODE,
				COLLECTION_DATE,
				TITLE,
				ORIGIN,
				EVALUATION,
				USER_SUMMARY,
				UPT_DATE,
				REG_DATE
            ) VALUES (
                SEQ_STOCKS_HIST.NEXTVAL,
                #{stocksCode},
                #{collectionDate},
                #{title},
                #{origin},
                #{evaluation},
                #{userSummary},
                SYSDATE,
                SYSDATE
            )
    </insert>
    
	<!-- 종목 이력 수정 -->
	<update id="updateStockHist" parameterType="java.util.Map">
		<![CDATA[/*updateStockHist*/
			UPDATE STOCKS_HIST
			SET 	TITLE = #{title},
					ORIGIN = #{origin},
					EVALUATION = #{evaluation},
					USER_SUMMARY = #{userSummary},
					UPT_DATE = SYSDATE
			WHERE SEQ = #{seq}
		]]>
	</update>
	
	<!-- 종목 이력 삭제 -->
	<delete id="deleteStockHist" parameterType="java.util.Map">
		<![CDATA[/*deleteStockHist*/
			DELETE FROM STOCKS_HIST
			WHERE SEQ = #{seq}		
		]]>
	</delete>
	
	 <!-- 종목 정보 수정 -->
	<update id="updateStocksInfoUptDate" parameterType="java.util.Map">
		<![CDATA[/*updateStocksInfoUptDate*/
			UPDATE STOCKS_LIST
			SET 	UPT_DATE = SYSDATE
			WHERE STOCKS_CODE = #{stocksCode} 
		]]>
	</update>
    
	
</mapper>